<!DOCTYPE html>
<html>
    <head>
        <title>Categorisation experiment</title>
        <script src="jspsych/jspsych.js"></script>
        <link rel="stylesheet" type="text/css" href="jspsych/css/jspsych.css"/>
        <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    	  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    	
    </head>
    <body>
      <div class = "parent">
        <div class = "child">
          <div id="jspsych_target"></div>
        </div>
      </div>
    </body>
    <script>

    var questions = ["longer", "shorter", "pointed up", "pointed down"]
    
    var questionnumber = jsPsych.data.getURLVariable('q')
    var targetfeature = questions[questionnumber-1]
    if (typeof targetfeature == 'undefined') {
      throw new Error("targetfeature undefined");
    }

    var question = "<p>On which side are the spikes <strong>"+targetfeature+"</strong>?</p>"+"<p>(F) left ---------- right (J)</p>"

    var turkcode = (Math.floor(Math.random() * 899999) + 100000).toString() + "TG";

    var timeline = []
    
    var researcher_name = "Dr. Tijl Grootswagers"
    var time_required = "15 minutes"
    var payment_amount = "$1.50"
    
    function strpad(num, size) {
        var s = num+"";
        while (s.length < size) s = "0" + s;
        return s;
    }
    var test_stimuli = []
    
    var images = []
    var stimnum = 0
    for (var len = -12; len <= 12; len++) {
      for (var ori = -12; ori <= 12; ori++) {
       stimnum++;
       path = "img/stim_"+strpad(stimnum,3)+"_len_"+strpad(len,2)+"_ori_"+strpad(ori,2)+".png";
       images.push(path);
       test_stimuli.push({stimulus: path, data: { test_part: 'test'}})
      }
    }
    test_stimuli = test_stimuli.slice(0,2)
    var nstim = test_stimuli.length
    
    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<p>In this experiment, an image will appear in the center of the screen.</p><p>" +
          "Use the letter F and J on your keyboard to indicate on which side the spikes are <strong>" + 
          targetfeature + "</strong></p>" +
          "<p>Respond as fast and accurately as you can.</p>" +
          "<p>Press any key to begin.</p>",
      post_trial_gap: 500
    };
    timeline.push(instructions);
    
    var fixation = {
      type: 'image-keyboard-response',
      stimulus: "img/fixation.png",
      prompt: question,
      choices: jsPsych.NO_KEYS,
      trial_duration: 250,
      data: {test_part: 'fixation'},
    }
    timeline.push(fixation);
    
    var test = {
      type: "image-keyboard-response",
      stimulus: jsPsych.timelineVariable('stimulus'),
      prompt: question,
      choices: ['f', 'j'],
      data: jsPsych.timelineVariable('data'),
      on_finish: function(){
        var count = jsPsych.data.get().count();
        jsPsych.setProgressBar(count/3/nstim);
      }
    }

    var test_procedure = {
      timeline: [fixation,test,fixation],
      timeline_variables: test_stimuli,
      randomize_order: true,
      repetitions: 1
    }
    timeline.push(test_procedure);

    var debrief_text = 'Experiment Finished!<br><br>'+
      'Your completion code is <span id="turkcode" style="font-weight:bold;font-size:130%">' + turkcode + 
        '</span><br><br>To receive payment for the HIT, return to the Amazon Mechanical Turk page, enter this code and submit the HIT.';
    
    // var debrief_block = {
    //   type: "html-keyboard-response",
    //   stimulus: debrief_text
    // };
    // timeline.push(debrief_block);
    
    // record the turkcode in the jsPsych data
    jsPsych.data.addProperties({
      turkcode: turkcode,
      targetfeature: targetfeature,
    });

    function endExperiment(dataset,turkcode,callback) {
      var datatext = dataset.replace(/(\r\n|\n|\r)/gm,'####')
      console.log(dataset) // comment out to avoid console log
      // var webhook_url='https://hooks.slack.com/services/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'
      // $.ajax({
      //     data: 'payload=' + JSON.stringify({
      //         text: turkcode,
      //         channel: "turk",
      //         attachments: [{
      //           title: "attach",
      //           text: datatext,
      //         }
      //       ],
      //     }),
      //     dataType: 'json',
      //     processData: false,
      //     type: 'POST',
      //     url: webhook_url
      // });
      setTimeout(callback,500)
    }
    
    jsPsych.init({
        timeline: timeline,
        show_progress_bar: true,
        preload_images: images,
        show_preload_progress_bar: true,
        auto_update_progress_bar: false,
        // on_finish: function() { 
        //     endExperiment(jsPsych.data.get().filter({test_part: "test"}).csv(),turkcode, function() {
        //     document.write('<div id="endscreen" class="endscreen" style="width:1000px"><div class="endscreen" style="text-align:center; border:0px solid; padding:10px; font-size:120%; width:800px; float:right"><p><br><br><br>Experiment Finished!<br><br>Your completion code is <span id="turkcode" style="font-weight:bold;font-size:130%">' + turkcode + '</span><br><br>To receive payment for the HIT, return to the Amazon Mechanical Turk page, enter this code and submit the HIT.</p></div></div>')
        //   }
        //   )
        // }
        on_finish: function() {
        //instead of displaying data in the on_finish callback, we post it to our server using an AJAX call:
        $.ajax({
          type: "POST",
          url: "/experiment-data",
          data: JSON.stringify(jsPsych.data.get().filter({test_part: "test"})),
          contentType: "application/json"
        })
        .done(function() {
          document.write(debrief_text)
        })
        .fail(function() {
          alert("A problem occurred while writing to the database. Please contact the researcher for more information.")
          document.write(jsPsych.data.get().filter({test_part: "test"}).csv())
        })
        }
    })

    /* start the experiment */
    // jsPsych.init({
    //   display_element: $('#jspsych_target'),
    //   experiment_structure: timeline,
    //   on_finish: function() {
    //     jsPsych.data.displayData();
    //     //instead of displaying data in the on_finish callback, we post it to our server using an AJAX call:
    //     $.ajax({
    //       type: "POST",
    //       url: "/experiment-data",
    //       data: JSON.stringify(jsPsych.data.getData()),
    //       contentType: "application/json"
    //     })
    //     .done(function() {
    //       //window.location.href = "finish";
    //       jsPsych.data.displayData();
    //     })
    //     .fail(function() {
    //       alert("A problem occurred while writing to the database. Please contact the researcher for more information.")
    //       window.location.href = "/";
    //       jsPsych.data.displayData();
    //     })
    //   }
    // });
    </script>
</html>